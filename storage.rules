rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    
    // ============================================
    // Helper Functions
    // ============================================
    
    // Check if user is authenticated
    function isSignedIn() {
      return request.auth != null;
    }
    
    // Check file size (in bytes)
    function isValidSize(maxSize) {
      return request.resource.size <= maxSize;
    }
    
    // Check if file is an image
    function isImage() {
      return request.resource.contentType.matches('image/.*');
    }
    
    // Check if file is a video
    function isVideo() {
      return request.resource.contentType.matches('video/.*');
    }
    
    // Check if file is audio
    function isAudio() {
      return request.resource.contentType.matches('audio/.*');
    }
    
    // ============================================
    // Storage Rules
    // ============================================
    
    // Media files (photos and videos)
    match /media/{allPaths=**} {
      // Anyone authenticated can read
      allow read: if isSignedIn();
      
      // Only authenticated users can upload
      // Max 100MB for images/videos
      allow write: if isSignedIn() &&
                      isValidSize(100 * 1024 * 1024) &&
                      (isImage() || isVideo());
      
      // Can delete own uploads
      allow delete: if isSignedIn();
    }
    
    // Music files
    match /music/{allPaths=**} {
      // Anyone authenticated can read
      allow read: if isSignedIn();
      
      // Only authenticated users can upload
      // Max 50MB for audio files
      allow write: if isSignedIn() &&
                      isValidSize(50 * 1024 * 1024) &&
                      isAudio();
      
      // Can delete own uploads
      allow delete: if isSignedIn();
    }
    
    // ============================================
    // Deny all other access
    // ============================================
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}
